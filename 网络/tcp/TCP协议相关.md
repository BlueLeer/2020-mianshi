# 听课笔记（还没有整理）

UDP是传大数据包的

但是对于哪些体积大的文件，例如视频、音乐等，就必须要先分拆成一个个的小数据包，然后再发送，因此引出了TCP协议。

TCP协议，即传输控制协议，它有以下特点：

* TCP是面向连接的**传输层**协议

  也就是必须要先建立连接（三次握手建立连接）。

* 每一条TCP连接只能有两个端点（endpoint），每一条TCP连接只能是点对点的（一对一）

  一个发，一个收。TCP连接的端点不是主机，不是主机的IP地址，不是应用进程，也不是传输层的协议端口。TCP连接的端点叫做**套接字**。套接字：socket = （IP地址:端口号）。也就是说：每条TCP连接唯一的被通信两端的两个端点（即两个套接字）锁确定。

* TCP提供可靠交付服务（如何实现可靠服务的）

* TCP提供全双工通信（每个端点可以同时发和收）

  发送者发送数据，接收者接收，接收者适时还要回复发送者数据有没有收到；发送者发快了，接收者处理不过来，会给发送者一个反馈；等等。。。所以必须是全双工的

* 面向字节流

  将数据先放入TCP缓存里面去，然后取出数据转化成二进制，发送给另一端，另一端是先放入TCP缓存，然后再对二进制数据进行解读



## TCP协议是如何实现可靠传输的

数据传输是由传输层传输的。

### 可靠传输的工作原理--停止等待协议

![](TCP是如何实现可靠传输.png)

分为2中情况:

* 无差错情况

  A发送出去了，B收到以后给A回复一个确认号（确认号是期待收到对方下一个报文段的第一个数据字节的序号 ），然后A收到B的响应以后，继续发送。

* 有差错（超时重传）

  A发送出去了，没有收到B的回复，就会默认等待 RTT再多一点儿时间（RTO，发送方根据RTO采样计算出来的），如果超过这个时间了，就会重新传。RTT指的是往返时延

触发超时重传，可能是B回复时包丢了，也可能是B的确认迟到了

![](TCP实现可靠传输确认迟到和确认丢失.png)

**记住一点，只要A没有收到B的回复，就会重传**。

使用上面的确认和重传机制，我们就可以在不可靠的传输网络上实现可靠的通信。这种可靠的传输协议常称为**自动重传请求ARQ（Automatic Repeat reQuest）**。

AQR表明重传的请求是自动进行的。接收方不需要请求发送方重传某个出错的分组（包）。

### 停止等待协议的缺点

大部分时间都浪费在等待接收方回复上面了，信道利用率低。

信道利用率公式：

`U = Td / (Td + RTT + Ta) `，Td指的是发送发送数据包需要的时间，Ta指的是接收回复所用的时间。分母几乎是确定的，为了提高信道利用率，就得提高RTT的值，因此就有了“**流水线传输**”



### 停止等待协议改进版----流水线传输

![](TCP是如何实现可靠传输的-流水线传输.png)



发送方可连续发送多个分组，不必每发完一个分组就停下来等待对方的确认（回复）。由于信道上一直有数据不间断的传送，这种传输方式可以获得很高的信道利用率。

那么问题由产生了，怎么实现可靠传输呢？也就是说我发数据出去了，怎么去确认对方有没有收到，以便于在没有收到确认的时候重新发送数据呢？所以就引出了 **连续AQR协议**

#### 连续AQR协议

![](TCP是如何实现可靠传输的-流水线传输-连续AQR协议.png)

发送窗口（滑动窗口）内的数据被保存到TCP缓存中，已经发送过的数据包收到确认以后，窗口往前移动。但是还会每个分组都必须要确认，效率还不是很高。改进方式是**累积确认**。

累积确认可以在1、2、3数据都收到的时候，之用回复A说3已经收到了，这样发送方就知道1/2/3都收到了。但是还是不够好，比如B收到了1.2.4.5，丢失了3怎么办，这个时候只能回复2,4.5就会重发。



## TCP报文的首部格式

![](TCP报文的首部格式.png)



由上图可知：

TCP首部由 20字节的固定首部+选项和填充部分，选项和填充部分是非必须的，所以TCP报文首部最小长度为20字节，此时选项和填充部分的长度为0个字节。

**源端口**，16位，也就2个字节，取值范围最大为1-65536，代表着发送端的端口号。

**目的端口**，16位，也就是2个字节，取值范围也是1-65536，代表着接收端的端口号。

**序号**，32位，也就是4个字节，代表当前分组的数据部分的第一个字节是整个待发送数据的第几个字节

**确认号**，32位，也就是4个字节，代表接收方已经收到了该字节编号以前的字节，期待下次对方发送的字节序号。

如下图所示，模拟了全双工通信时，确认号和序号的规则：

![](TCP报文发送首部的规则.png)



#### 标记位（标识位）说明

他们都是1位，要么是0，要么是1

* URG：为1时，标识紧急指针有效。啥意思呢？也就是不在发送方的TCP缓存里面排队了，马上将此分组传给接收方，相当于这个数据包发送时要插队了，对于终止传送很有效。
* ACK：确认标识，连接建立成功后，总为1。为1时确认号有效 
* SYN：为1时，代表客户端建立连接的请求包；当服务端同意建立TCP连接时，这个标识也会传1
* PSH：为1时，接收方应尽快把这个报文交给应用层
* RST：复位标识，重新建立连接。在浏览器中请求一个http地址，突然点击了一个刷新，此时RST就会设置为1
* FIN：数据传输完了，此时就要释放连接，此时这个标识就是1



#### 窗口

接收端期望接收的字节数。解决流量控制问题。



#### MSS 最长报文大小

- 最常见的可选字段
- MSS只能出现在SYN时传过来（第一次握手和第二次握手时）
- 指明本端能接收的最大长度的报文段
- 建立连接时，双方都要发送MSS
- 如果不发送，默认为536字节



#### 校验和

由发送端计算和存储，由接收端校验。解决数据正确性问题。

它校验TCP首部和数据两个部分



#### 紧急指针

紧急指针指明了紧急数据尾部在这个数据包里面的第多少个字节，例如紧急指针是50，表明1-50字节是需要紧急处理的，50以后的是不着急的





## TCP是如何实现可靠传输的

前面提到的停止等待和累积确认都有弊端，下面介绍的是非常接近真实的TCP实现可靠传输的机制

1. 以字节为单位的滑动窗口技术

   ![](TCP是如何实现可靠传输的-滑动窗口技术.png)

   滑动窗口会在TCP缓存中移动，A的发送窗口和B的接收窗口大小是一样的。当滑动窗口中的数据已经被发送了，并且接收方已经应答了，则由左至右选取已经被发送的连续数据，给予回复。例如：A收到了来自B的1.2.3.4.5.8.9.10数据已收到的应答，则会在将滑动窗口往前移动到 6的位置处。

   我们知道，A发送给B数据以后，如果B没有收到，或者B收到了但是再给A应答的包丢失了，此时A就要重传数据包给B。**TCP每发送一个报文段，就对这个报文段设置一次计时器。只要计时器设置的重传时间到了但是还没有收到确认，就要重传这一报文段。**











> 扩展：为什么视频用UDP而不是用的TCP？
>
> tcp需要进行三次握手，建立会话需要时间，tcp在网络拥塞的情况下会进行tcp全局同步，根据网络带宽调整tcp滑动窗口大小，引起tcp传输速度下降，甚至有可能会导致tcp报文没有带宽可用，导致tcp饿死，而视频传输对带宽的需求比较大，对时延要求比较高，对丢包率要求不是那么高，udp是面向无连接的传输协议，不需要进行三次握手，也没有tcp的滑动窗口，报文也比tcp小，正好满足了对视频传输的要求 













学完以后要能回答出这几个问题：

* TCP如何实现可靠传输的
* TCp怎么实现流量控制的
* TCP怎么避免网络堵塞的