> 本文参考:
>
> [分布式任务调度框架XXL-JOB解析（一）概述及搭建](https://juejin.im/post/5dd133005188252ad04c4f94 )
>
> [分布式任务调度框架XXL-JOB解析（二）注册心跳](https://juejin.im/post/5dd1f1a2f265da0bd71ff2be )
>
> [分布式任务调度框架XXL-JOB解析（三）任务调度](https://juejin.im/post/5dd235f76fb9a0201b46a8d6 )

# xxl-job使用总结

xxl-job的老版本是依赖quartz的定时任务触发，在v2.1.0版本开始，移除了quartz依赖：一方面是为了精简系统降低冗余依赖，另一方面是为了提升系统的可控性和稳定性。



## 1.quartz的不足

quartz和xxl-job对比，什么时候选用quartz，什么时候选用xxl-job？-------待思考



## 2.xxl-job的设计思想

将调度行为抽象形成调度中心公共平台，而平台自身并不承担业务逻辑，**调度中心**负责发起调度请求。

将任务抽象成分散的JobHandler，交由**执行器**统一管理，执行器负责接收调度请求并执行对应的JobHandler中业务逻辑。

因此，我们可以看出，调度和任务两部分可以相互解耦，提供系统整体稳定性和扩展性。











## corn表达式复习

cron表达式是一个字符串，字符串以5个或者6个空格隔开，分成6或者7个域，每个域都代表一种含义，Cron有如下两种语法格式：

* Seconds Minutes Hours DayOfMonth Month DayOfWeek
* Seconds Minutes Hours DayOfMonth Month DayOfWeek Year

6个域的时候没有年，7个域的时候包含了一个年的配置。





项目名称：20视频社交

项目描述：20视频社交APP隶属于20互娱，致力于为用户提供高清、流畅而丰富的互动式视频社交服务，除了满足基本视频社交功能外，更推出视频社交行业的新模式，全新模式一对一视频社交。用户可以和在线主播进行视频聊天，发消息，在聊天过程中用户可以赠送礼物。通过视频、消息、聊天收费为主播带来了收益的同时，也激发了大量主播的入驻。

涉及技术：Spring Cloud Alibaba、MySQL、Redis、nacos、Sentinel、seata、docker、xxl-job等

设计技术：

1. 采用分布式架构，整个项目分为：活动、公会、网关、阿里云、结算、礼物、公会、支付、推荐、用户等十多个微服务
2. 使用Spring Cloud Alibaba实现了整个微服务架构，对内RPC、对外REST，实现各个微服务之间的解耦。
3. 聚合了声网SDK实现视频和消息发送，聚合了阿里云的风险提示、实名认证、秒验、短信、对象存储、智能推荐等云产品实现了简单开发。

责任描述：

1. 参与公会系统开发，主播数据统计，公会经营数据统计；公会下经纪人、管理员多类型角色权限控制开发，不同角色类型展示不同的数据；负责主播升降级、公会升降级、保底费发放等定时任务开发和维护
2. 参与APP后端接口开发
3. 对接阿里智能推荐云产品，上报用户、物品、行为相关信息，以及行为数据埋点实时推送至智能推荐。以实现对用户推荐匹配度高的主播。

项目收获：对Spring Cloud Alibaba实施微服务有了一个清晰的认识，尤其是在对外REST、对内RPC的微服务调用方式有了一个初步的了解和实践。在处理接口调用超时，Dubbo调用超时重试情况下造成问题的处理方式有了一个实践。在智能推荐模块开发时，将行为信息上报、物品新增和更新、用户新增和更新进行埋点时，为了不影响原接口的响应时间，使用了Dubbo的异步调用方式（代码见下面）。

```java
// 异步调用
RpcContext.getContext().asyncCall(() -> {
    behaviorCollectService.testAsync("hello");
});
```

你在项目中遇到的问题：

1.在做智能推荐的时候，因为要定时将主播的在线状态同步到阿里智能推荐服务上面去，就需要去redis里面找到在线用户的ID列表（用户的在线状态是通过两级来判定的，Redis里面存了在线用户的ID，过期时间是5分钟，数据库里面也存了，如果Redis里面有该用户的ID，则再去查数据库中）

